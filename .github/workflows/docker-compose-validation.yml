name: Validate Docker Compose Services

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

jobs:
  docker-compose-validation:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Tools
      run: |
        set +x
        sudo apt-get update > /dev/null 2>&1
        sudo apt-get install -y netcat-openbsd curl > /dev/null 2>&1
        curl -L https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64 -o /usr/local/bin/yq > /dev/null 2>&1
        chmod +x /usr/local/bin/yq
        echo "âœ… Ferramentas instaladas com sucesso!"

    - name: Docker Compose Up
      run: |
        set +x
        echo "ğŸš€ Subindo containers do docker-compose..."
        docker compose up -d > /dev/null 2>&1
        echo "âœ… Containers rodando."

    - name: Wait for containers to be ready
      run: |
        set +x
        echo "â³ Esperando containers ficarem prontos..."
        sleep 15
        echo "âœ… Containers prontos."

    - name: Create validation script
      run: |
        set +x
        echo "ğŸ› ï¸ Criando script de validaÃ§Ã£o..."
        cat << 'EOF' > validate_services.sh
        #!/bin/bash
        set -e
        set +x

        echo "ğŸ“ Criando relatÃ³rio de validaÃ§Ã£o..."
        docker run -d --name test_container --network internal_network busybox tail -f /dev/null > /dev/null 2>&1
        docker network connect external_network test_container > /dev/null 2>&1

        echo "| ServiÃ§o           | Porta | Status    | Dica                          |" > validation_report.md
        echo "|:------------------|:------|:----------|:------------------------------|" >> validation_report.md

        SERVICES=$(yq e '.services | keys | .[]' docker-compose.yml)

        for service in $SERVICES; do
          echo "ğŸ” Verificando serviÃ§o: $service"

          EXPOSE_PORT=$(yq e ".services.\"$service\".expose[0]" docker-compose.yml)

          if [ "$EXPOSE_PORT" == "null" ] || [ -z "$EXPOSE_PORT" ]; then
            EXPOSE_PORT=$(yq e ".services.\"$service\".ports[0]" docker-compose.yml | cut -d':' -f2)
          fi

          if [ "$EXPOSE_PORT" == "null" ] || [ -z "$EXPOSE_PORT" ]; then
            echo "âŒ ServiÃ§o $service nÃ£o declarou 'expose' nem 'ports'."
            echo "ğŸ’¡ Dica: adicione expose: [\"PORTA\"] no docker-compose.yml"
            echo "| $(printf '%-18s' $service) |   -   | âŒ Falhou | Adicione expose/ports    |" >> validation_report.md
            exit 1
          fi

          echo "ğŸ”Œ Testando conexÃ£o para $service:$EXPOSE_PORT"
          docker exec test_container sh -c "nc -z -w 5 $service $EXPOSE_PORT" > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "âŒ Falha na conexÃ£o TCP para $service:$EXPOSE_PORT"
            echo "ğŸ’¡ Dica: verifique se o serviÃ§o $service estÃ¡ escutando corretamente."
            echo "| $(printf '%-18s' $service) | $EXPOSE_PORT | âŒ Falhou | Corrija o serviÃ§o       |" >> validation_report.md
            exit 1
          else
            echo "âœ… ConexÃ£o OK para $service:$EXPOSE_PORT"
            echo "| $(printf '%-18s' $service) | $EXPOSE_PORT | âœ… OK     |                              |" >> validation_report.md
          fi
        done
        EOF

        chmod +x validate_services.sh
        echo "âœ… Script de validaÃ§Ã£o criado."

    - name: Run validation script
      run: |
        set +x
        echo "ğŸƒâ€â™‚ï¸ Executando validaÃ§Ã£o dos serviÃ§os..."
        ./validate_services.sh
        echo "âœ… ValidaÃ§Ã£o concluÃ­da."

    - name: Upload RelatÃ³rio de ValidaÃ§Ã£o
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: docker-compose-validation-report
        path: validation_report.md

    - name: Cleanup
      if: always()
      run: |
        set +x
        echo "ğŸ§¹ Limpando containers..."
        docker rm -f test_container > /dev/null 2>&1 || true
        docker compose down > /dev/null 2>&1
        echo "âœ… Cleanup finalizado."
